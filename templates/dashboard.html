{% extends "base.html" %}

{% block title %}Discover - Fall In{% endblock %}

{% block content %}
<style>
    :root {
        --baby-pink: #fdf2f8;
        --soft-pink: #fce7f3;
        --medium-pink: #f9a8d4;
        --bright-pink: #ec4899;
        --dark-pink: #be185d;
        --accent-pink: #f472b6;
        --light-pink: #fbcfe8;
    }

    /* Card Stack Container */
    .card-stack {
        position: relative;
        width: 100%;
        max-width: 400px;
        height: 650px;
        margin: 0 auto;
        perspective: 1000px;
        transform-style: preserve-3d;
    }

    /* Individual Cards - Realistic Dating App Style */
    .swipe-card {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        border-radius: 24px;
        box-shadow: 
            0 8px 32px rgba(244, 114, 182, 0.15),
            0 2px 8px rgba(244, 114, 182, 0.1);
        cursor: grab;
        user-select: none;
        touch-action: pan-y;
        transform-origin: center bottom;
        transition: none;
        will-change: transform;
        overflow: hidden;
        border: 1px solid rgba(244, 114, 182, 0.08);
    }

    .swipe-card:active {
        cursor: grabbing;
    }

    /* Card stack depth effect - like Tinder */
    .swipe-card:nth-child(1) { 
        z-index: 5; 
        transform: scale(1) translateY(0px) translateZ(0px);
    }
    .swipe-card:nth-child(2) { 
        z-index: 4; 
        transform: scale(0.96) translateY(8px) translateZ(-20px);
        opacity: 0.9;
    }
    .swipe-card:nth-child(3) { 
        z-index: 3; 
        transform: scale(0.92) translateY(16px) translateZ(-40px);
        opacity: 0.8;
    }
    .swipe-card:nth-child(4) { 
        z-index: 2; 
        transform: scale(0.88) translateY(24px) translateZ(-60px);
        opacity: 0.7;
    }

    /* Like/Nope Overlays - Tinder Style */
    .swipe-overlay {
        position: absolute;
        top: 15%;
        width: 120px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 1.5rem;
        font-weight: 800;
        letter-spacing: 0.05em;
        opacity: 0;
        transition: opacity 0.1s ease;
        border: 3px solid;
        backdrop-filter: blur(8px);
        z-index: 10;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .like-overlay {
        right: 15px;
        color: #059669;
        background: rgba(5, 150, 105, 0.15);
        border-color: #059669;
        transform: rotate(15deg);
    }

    .nope-overlay {
        left: 15px;
        color: #dc2626;
        background: rgba(220, 38, 38, 0.15);
        border-color: #dc2626;
        transform: rotate(-15deg);
    }

    /* Super Like Overlay */
    .super-overlay {
        top: 8%;
        left: 50%;
        transform: translateX(-50%);
        color: #2563eb;
        background: rgba(37, 99, 235, 0.15);
        border-color: #2563eb;
    }

    /* Action Buttons - Baby Pink Theme */
    .action-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: rgba(253, 242, 248, 0.8);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        margin: 20px;
        box-shadow: 0 4px 20px rgba(244, 114, 182, 0.1);
        border: 1px solid rgba(244, 114, 182, 0.1);
    }

    .action-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .action-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .action-btn:active {
        transform: scale(0.95);
    }

    .reject-btn {
        background: linear-gradient(135deg, #fef2f2, #fecaca);
        color: #dc2626;
        border: 2px solid rgba(220, 38, 38, 0.2);
    }

    .reject-btn:hover {
        background: linear-gradient(135deg, #fecaca, #f87171);
        border-color: rgba(220, 38, 38, 0.4);
    }

    .super-btn {
        background: linear-gradient(135deg, #eff6ff, #bfdbfe);
        color: #2563eb;
        width: 48px;
        height: 48px;
        font-size: 1rem;
        border: 2px solid rgba(37, 99, 235, 0.2);
    }

    .super-btn:hover {
        background: linear-gradient(135deg, #bfdbfe, #60a5fa);
        border-color: rgba(37, 99, 235, 0.4);
    }

    .like-btn {
        background: linear-gradient(135deg, #f0fdf4, #bbf7d0);
        color: #059669;
        border: 2px solid rgba(5, 150, 105, 0.2);
    }

    .like-btn:hover {
        background: linear-gradient(135deg, #bbf7d0, #4ade80);
        border-color: rgba(5, 150, 105, 0.4);
    }

    .chat-btn {
        background: linear-gradient(135deg, #fdf4ff, #e9d5ff);
        color: #9333ea;
        border: 2px solid rgba(147, 51, 234, 0.2);
    }

    .chat-btn:hover {
        background: linear-gradient(135deg, #e9d5ff, #c084fc);
        border-color: rgba(147, 51, 234, 0.4);
    }

    /* Profile info styling */
    .profile-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
        color: white;
        padding: 30px 20px 20px;
        border-radius: 0 0 20px 20px;
    }

    .profile-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 4px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .profile-details {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 8px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Prompt styling */
    .prompt-bubble {
        background: rgba(255, 255, 255, 0.9);
        color: var(--dark-pink);
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-top: 8px;
        display: inline-block;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(244, 114, 182, 0.2);
    }

    /* Info Cards - Baby Pink Theme */
    .info-card {
        background: rgba(253, 242, 248, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(244, 114, 182, 0.1);
        border-radius: 12px;
        margin: 8px;
        padding: 12px;
        transition: all 0.2s ease;
    }

    .info-card:hover {
        background: rgba(252, 231, 243, 0.9);
        border-color: rgba(244, 114, 182, 0.2);
    }

    /* Scrollable Additional Info Section */
    .additional-info-container {
        max-height: 220px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(244, 114, 182, 0.5) transparent;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        border: 1px solid rgba(244, 114, 182, 0.1);
        border-radius: 12px;
        background: rgba(253, 242, 248, 0.8);
        margin: 8px;
        position: relative;
        padding-bottom: 20px;
    }

    .additional-info-container::-webkit-scrollbar {
        width: 6px;
    }

    .additional-info-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .additional-info-container::-webkit-scrollbar-thumb {
        background: rgba(244, 114, 182, 0.6);
        border-radius: 3px;
    }

    .additional-info-container::-webkit-scrollbar-thumb:hover {
        background: rgba(244, 114, 182, 0.8);
    }

    /* Hover effect for scrollable content */
    .swipe-card:hover .additional-info-container {
        scrollbar-color: rgba(244, 114, 182, 0.5) transparent;
    }

    /* Mobile scroll indicator */
    @media (max-width: 768px) {
        .additional-info-container {
            max-height: 180px;
        }
        
        .additional-info-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .additional-info-container::-webkit-scrollbar-thumb {
            background: rgba(244, 114, 182, 0.6);
        }
    }

    /* Scroll fade indicators */
    .additional-info-container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(transparent, rgba(253, 242, 248, 0.9));
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .additional-info-container.has-more-content::after {
        opacity: 1;
    }

    /* Smooth physics animations */
    .card-exit-left {
        animation: swipeLeft 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .card-exit-right {
        animation: swipeRight 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .card-exit-up {
        animation: swipeUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes swipeLeft {
        to {
            transform: translateX(-150%) rotate(-30deg) scale(0.8);
            opacity: 0;
        }
    }

    @keyframes swipeRight {
        to {
            transform: translateX(150%) rotate(30deg) scale(0.8);
            opacity: 0;
        }
    }

    @keyframes swipeUp {
        to {
            transform: translateY(-150%) scale(0.8);
            opacity: 0;
        }
    }

    /* Stack animation when card is removed */
    .card-stack-update {
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Toast animations */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translate(-50%, -20px);
        }
        to {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    }
    
    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        to {
            opacity: 0;
            transform: translate(-50%, -20px);
        }
    }

    /* Mobile responsiveness */
    @media (max-width: 480px) {
        .card-stack {
            max-width: 350px;
            height: 550px;
        }
        
        .action-btn {
            width: 50px;
            height: 50px;
            font-size: 1.1rem;
        }
        
        .super-btn {
            width: 42px;
            height: 42px;
        }

        .action-buttons {
            gap: 15px;
            padding: 15px;
            margin: 15px;
        }

        .profile-name {
            font-size: 1.3rem;
        }

        .profile-details {
            font-size: 0.8rem;
        }

        .prompt-bubble {
            font-size: 0.75rem;
            padding: 6px 10px;
        }
    }

    /* Desktop optimizations - More compact and usable */
    @media (min-width: 768px) {
        .card-stack {
            max-width: 450px;
            height: 600px;
        }
        
        .action-btn {
            width: 60px;
            height: 60px;
            font-size: 1.2rem;
        }
        
        .super-btn {
            width: 50px;
            height: 50px;
            font-size: 1rem;
        }

        .action-buttons {
            gap: 20px;
            padding: 20px;
            margin: 20px;
        }

        .profile-name {
            font-size: 1.5rem;
        }

        .profile-details {
            font-size: 0.9rem;
        }

        .prompt-bubble {
            font-size: 0.85rem;
            padding: 8px 12px;
        }

        .info-card {
            padding: 12px;
            margin: 8px;
        }

        .info-card .text-xs {
            font-size: 0.75rem;
        }

        .info-card .text-sm {
            font-size: 0.85rem;
        }
    }

    /* Large desktop screens - Moderate scaling */
    @media (min-width: 1024px) {
        .card-stack {
            max-width: 500px;
            height: 650px;
        }
        
        .action-btn {
            width: 65px;
            height: 65px;
            font-size: 1.3rem;
        }
        
        .super-btn {
            width: 55px;
            height: 55px;
            font-size: 1.1rem;
        }

        .action-buttons {
            gap: 25px;
            padding: 25px;
            margin: 25px;
        }

        .profile-name {
            font-size: 1.75rem;
        }

        .profile-details {
            font-size: 1rem;
        }

        .prompt-bubble {
            font-size: 0.9rem;
            padding: 10px 14px;
        }
    }

    /* Extra large screens - Slightly larger but still reasonable */
    @media (min-width: 1280px) {
        .card-stack {
            max-width: 550px;
            height: 700px;
        }
        
        .action-btn {
            width: 70px;
            height: 70px;
            font-size: 1.4rem;
        }
        
        .super-btn {
            width: 60px;
            height: 60px;
            font-size: 1.2rem;
        }

        .action-buttons {
            gap: 30px;
            padding: 30px;
            margin: 30px;
        }

        .profile-name {
            font-size: 2rem;
        }

        .profile-details {
            font-size: 1.1rem;
        }

        .prompt-bubble {
            font-size: 1rem;
            padding: 12px 16px;
        }
    }

    /* Loading animation */
    .loading {
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
</style>

<div class="pb-32 min-h-screen">
    <div class="max-w-md mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-6 slide-up">
            <h1 class="text-2xl font-bold gradient-text">Discover</h1>
            <p class="text-gray-600">Find your person between the classes.</p>
        </div>

        {% if potential_matches %}
        <!-- Card Stack -->
        <div class="card-stack" id="cardStack">
            {% for match in potential_matches %}
            <div class="swipe-card" data-user-id="{{ match.id }}" data-user-name="{{ match.name }}">
                <div class="like-overlay">LIKE</div>
                <div class="nope-overlay">NOPE</div>
                <div class="super-overlay">SUPER LIKE</div>
                
                <!-- Profile Image -->
                <div class="h-96 relative overflow-hidden" style="background: linear-gradient(135deg, var(--medium-pink), var(--bright-pink));">
                    {% if match.profile_photo %}
                        {% if match.profile_photo.startswith('data:image') %}
                            <img src="{{ match.profile_photo }}" 
                                 alt="{{ match.name }}" class="w-full h-full object-cover">
                        {% else %}
                            <img src="{{ url_for('static', filename='uploads/' + match.profile_photo) }}" 
                                 alt="{{ match.name }}" class="w-full h-full object-cover">
                        {% endif %}
                    {% else %}
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center text-white">
                                <i class="fas fa-user text-6xl mb-4 opacity-50"></i>
                                <p class="text-lg font-semibold opacity-75">{{ match.name }}</p>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Profile Info Overlay -->
                    <div class="profile-info">
                        <div class="profile-name">{{ match.name }}, {{ match.age }}</div>
                        <div class="profile-details">{{ match.department }} • {{ match.year }}</div>
                        {% if match.bio %}
                        <div class="prompt-bubble">
                            {{ match.bio[:80] }}{% if match.bio|length > 80 %}...{% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Additional Info -->
                {% if match.prompts %}
                <div class="additional-info-container">
                    <div class="sticky top-0 bg-gradient-to-b from-pink-50 to-transparent p-3 text-center border-b border-pink-200">
                        <div class="text-xs text-pink-600 font-semibold">
                           
                        </div>
                    </div>
                    <div class="p-4 space-y-3">
                        {% for prompt in match.prompts.split(' | ') %}
                            {% if prompt and ':' in prompt %}
                            <div class="info-card">
                                <div class="text-xs font-semibold gradient-text">{{ prompt.split(':')[0] }}</div>
                                <div class="text-sm text-gray-700 mt-1">{{ prompt.split(':')[1] }}</div>
                            </div>
                            {% endif %}
                        {% endfor %}
                        <!-- Extra space at the bottom to ensure all content is accessible -->
                        <div class="h-8"></div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn reject-btn" id="rejectBtn" title="Pass">
                <i class="fas fa-times"></i>
            </button>
            <button class="action-btn chat-btn" id="chatBtn" title="Request Chat">
                <i class="fas fa-comment"></i>
            </button>
            <button class="action-btn super-btn" id="superBtn" title="Super Like">
                <i class="fas fa-star"></i>
            </button>
            <button class="action-btn like-btn" id="likeBtn" title="Like">
                <i class="fas fa-heart"></i>
            </button>
        </div>

        <!-- Instructions -->
        <div class="text-center mt-6 p-4 rounded-2xl glass">
            <p class="text-sm gradient-text">
                <i class="fas fa-hand-pointer mr-2"></i>
                Swipe right to like, left to pass, or up for super like!
            </p>
        </div>
        
        {% else %}
        <!-- No More Cards -->
        <div class="text-center py-16 slide-up">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 heartbeat" style="background: linear-gradient(135deg, var(--medium-pink), var(--bright-pink));">
                <i class="fas fa-heart text-3xl text-white"></i>
            </div>
            <h3 class="text-xl font-bold mb-2 gradient-text">No more profiles</h3>
            <p class="text-gray-600 mb-6">Check back later for new students!</p>
            <a href="{{ url_for('matches') }}" 
               class="inline-block text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg btn-primary">
                View Your Matches
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
class RealisticSwipe {
    constructor() {
        this.cards = Array.from(document.querySelectorAll('.swipe-card'));
        this.currentCard = null;
        this.isDragging = false;
        this.startX = 0;
        this.startY = 0;
        this.currentX = 0;
        this.currentY = 0;
        this.velocity = { x: 0, y: 0 };
        this.lastTime = 0;
        this.lastX = 0;
        this.lastY = 0;
        
        // Physics constants
        this.throwThreshold = 80;
        this.superLikeThreshold = -120;
        this.rotationMultiplier = 0.1;
        this.opacityMultiplier = 0.003;
        
        this.init();
    }
    
    init() {
        this.setCurrentCard();
        this.addEventListeners();
        this.addButtonListeners();
        this.setupScrollIndicators();
        console.log('Swipe system initialized with', this.cards.length, 'cards');
    }
    
    setCurrentCard() {
        this.currentCard = this.cards.find(card => 
            card.style.display !== 'none' && 
            !card.classList.contains('card-exit-left', 'card-exit-right', 'card-exit-up')
        );
        
        if (this.currentCard) {
            this.addCardListeners(this.currentCard);
            console.log('Current card set:', this.currentCard.dataset.userName);
        }
    }
    
    addCardListeners(card) {
        // Mouse events
        card.addEventListener('mousedown', this.onStart.bind(this));
        document.addEventListener('mousemove', this.onMove.bind(this));
        document.addEventListener('mouseup', this.onEnd.bind(this));
        
        // Touch events
        card.addEventListener('touchstart', this.onStart.bind(this), { passive: false });
        document.addEventListener('touchmove', this.onMove.bind(this), { passive: false });
        document.addEventListener('touchend', this.onEnd.bind(this));
        
        // Prevent default dragging
        card.addEventListener('dragstart', e => e.preventDefault());
        
        // Add scroll event listeners for the additional info container
        const scrollContainer = card.querySelector('.additional-info-container');
        if (scrollContainer) {
            scrollContainer.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            }, { passive: true });
            
            scrollContainer.addEventListener('touchmove', (e) => {
                e.stopPropagation();
            }, { passive: true });
            
            scrollContainer.addEventListener('mousedown', (e) => {
                e.stopPropagation();
            });
            
            scrollContainer.addEventListener('wheel', (e) => {
                e.stopPropagation();
            });
        }
    }
    
    addEventListeners() {
        // Prevent scrolling when dragging
        document.addEventListener('touchmove', (e) => {
            if (this.isDragging) {
                e.preventDefault();
            }
        }, { passive: false });
    }
    
    addButtonListeners() {
        const rejectBtn = document.getElementById('rejectBtn');
        const likeBtn = document.getElementById('likeBtn');
        const superBtn = document.getElementById('superBtn');
        const chatBtn = document.getElementById('chatBtn');

        if (rejectBtn) {
            rejectBtn.addEventListener('click', () => {
                this.animateReject();
                hapticFeedback('medium');
            });
        }
        
        if (likeBtn) {
            likeBtn.addEventListener('click', () => {
                this.animateLike();
                hapticFeedback('medium');
            });
        }
        
        if (superBtn) {
            superBtn.addEventListener('click', () => {
                this.animateSuperLike();
                hapticFeedback('heavy');
            });
        }
        
        if (chatBtn) {
            chatBtn.addEventListener('click', () => {
                this.animateChatRequest();
                hapticFeedback('medium');
            });
        }
    }

    setupScrollIndicators() {
        const scrollContainers = document.querySelectorAll('.additional-info-container');
        scrollContainers.forEach(container => {
            const content = container.querySelector('.p-4');
            if (content && content.scrollHeight > container.clientHeight) {
                container.classList.add('has-more-content');
            }
            
            container.addEventListener('scroll', () => {
                const isAtBottom = container.scrollTop + container.clientHeight >= content.scrollHeight - 10;
                if (isAtBottom) {
                    container.classList.remove('has-more-content');
                } else {
                    container.classList.add('has-more-content');
                }
            });
        });
    }
    
    onStart(e) {
        if (!this.currentCard) return;
        
        this.isDragging = true;
        this.currentCard.style.transition = 'none';
        
        const clientX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
        const clientY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
        
        this.startX = clientX;
        this.startY = clientY;
        this.lastX = clientX;
        this.lastY = clientY;
        this.lastTime = Date.now();
        
        hapticFeedback('light');
    }
    
    onMove(e) {
        if (!this.isDragging || !this.currentCard) return;
        
        e.preventDefault();
        
        const clientX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
        const clientY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
        
        this.currentX = clientX - this.startX;
        this.currentY = clientY - this.startY;
        
        // Calculate velocity for momentum
        const now = Date.now();
        const timeDelta = now - this.lastTime;
        if (timeDelta > 0) {
            this.velocity.x = (clientX - this.lastX) / timeDelta;
            this.velocity.y = (clientY - this.lastY) / timeDelta;
        }
        this.lastX = clientX;
        this.lastY = clientY;
        this.lastTime = now;
        
        this.updateCardTransform();
        this.updateOverlays();
    }
    
    onEnd() {
        if (!this.isDragging || !this.currentCard) return;
        
        this.isDragging = false;
        
        // Check for throw with momentum
        const momentumX = this.currentX + (this.velocity.x * 100);
        const momentumY = this.currentY + (this.velocity.y * 100);
        
        if (momentumY < this.superLikeThreshold) {
            this.animateSuperLike();
        } else if (momentumX > this.throwThreshold) {
            this.animateLike();
        } else if (momentumX < -this.throwThreshold) {
            this.animateReject();
        } else {
            this.snapBack();
        }
    }
    
    updateCardTransform() {
        if (!this.currentCard) return;
        
        const rotation = this.currentX * this.rotationMultiplier;
        const opacity = Math.max(0.7, 1 - (Math.abs(this.currentX) * this.opacityMultiplier));
        
        this.currentCard.style.transform = `
            translate(${this.currentX}px, ${this.currentY}px) 
            rotate(${rotation}deg)
        `;
        this.currentCard.style.opacity = opacity;
    }
    
    updateOverlays() {
        if (!this.currentCard) return;
        
        const likeOverlay = this.currentCard.querySelector('.like-overlay');
        const nopeOverlay = this.currentCard.querySelector('.nope-overlay');
        const superOverlay = this.currentCard.querySelector('.super-overlay');
        
        // Reset all overlays
        likeOverlay.style.opacity = '0';
        nopeOverlay.style.opacity = '0';
        superOverlay.style.opacity = '0';
        
        if (this.currentY < -50) {
            // Super like
            superOverlay.style.opacity = Math.min(1, Math.abs(this.currentY) / 100);
        } else if (this.currentX > 30) {
            // Like
            likeOverlay.style.opacity = Math.min(1, this.currentX / 100);
        } else if (this.currentX < -30) {
            // Nope
            nopeOverlay.style.opacity = Math.min(1, Math.abs(this.currentX) / 100);
        }
    }
    
    snapBack() {
        if (!this.currentCard) return;
        
        this.currentCard.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease';
        this.currentCard.style.transform = '';
        this.currentCard.style.opacity = '1';
        
        // Reset overlays
        this.updateOverlaysToZero();
        
        // Reset physics
        this.currentX = 0;
        this.currentY = 0;
        this.velocity = { x: 0, y: 0 };
    }
    
    updateOverlaysToZero() {
        if (!this.currentCard) return;
        
        const overlays = this.currentCard.querySelectorAll('.swipe-overlay');
        overlays.forEach(overlay => {
            overlay.style.opacity = '0';
        });
    }
    
    animateLike() {
        if (!this.currentCard) return;
        
        const userId = this.currentCard.dataset.userId;
        const userName = this.currentCard.dataset.userName;
        
        this.sendAction(userId, 'like');
        this.showToast('❤️ Liked ' + userName + '!', 'success');
        this.currentCard.classList.add('card-exit-right');
        this.removeCardAfterAnimation();
    }
    
    animateReject() {
        if (!this.currentCard) return;
        
        const userId = this.currentCard.dataset.userId;
        const userName = this.currentCard.dataset.userName;
        
        this.sendAction(userId, 'pass');
        this.showToast('👋 Passed on ' + userName, 'info');
        this.currentCard.classList.add('card-exit-left');
        this.removeCardAfterAnimation();
    }
    
    animateSuperLike() {
        if (!this.currentCard) return;
        
        const userId = this.currentCard.dataset.userId;
        const userName = this.currentCard.dataset.userName;
        
        this.sendAction(userId, 'super_like');
        this.showToast('⭐ Super Liked ' + userName + '!', 'super');
        this.currentCard.classList.add('card-exit-up');
        this.removeCardAfterAnimation();
    }
    
    animateChatRequest() {
        if (!this.currentCard) return;
        
        const userId = this.currentCard.dataset.userId;
        const userName = this.currentCard.dataset.userName;
        
        this.sendChatRequest(userId);
        this.showToast('💬 Chat request sent to ' + userName + '!', 'info');
        this.currentCard.classList.add('card-exit-up');
        this.removeCardAfterAnimation();
    }
    
    sendAction(userId, action) {
        const url = action === 'like' ? `/like/${userId}` : `/pass/${userId}`;
        
        fetch(url, { method: 'GET' })
            .then(response => response.text())
            .then(html => {
                // Only show match modal if it's actually a mutual match
                
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Connection error. Please try again.', 'error');
            });
    }
    
    sendChatRequest(userId) {
        fetch(`/request-chat/${userId}`, { method: 'GET' })
            .then(response => response.text())
            .then(html => {
                console.log('Chat request sent successfully');
            })
            .catch(error => {
                console.error('Error sending chat request:', error);
                showToast('Connection error. Please try again.', 'error');
            });
    }
    
    showMatchModal(userId) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl p-8 text-center max-w-sm mx-4 glass">
                <div class="text-6xl mb-4 heartbeat">💖</div>
                <h2 class="text-2xl font-bold mb-2 gradient-text">It's a Match!</h2>
                <p class="text-gray-600 mb-6">You and this person liked each other</p>
                <div class="flex space-x-3">
                    <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                        Keep Playing
                    </button>
                    <a href="/matches" class="flex-1 text-white py-3 rounded-xl font-semibold text-center btn-primary">
                        Say Hello
                    </a>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (modal.parentNode) {
                modal.remove();
            }
        }, 5000);
    }
    
    removeCardAfterAnimation() {
        setTimeout(() => {
            if (this.currentCard) {
                this.currentCard.style.display = 'none';
                this.updateCardStack();
                this.setCurrentCard();
                
                if (!this.currentCard) {
                    this.showNoMoreCards();
                }
            }
        }, 300);
    }
    
    updateCardStack() {
        const visibleCards = this.cards.filter(card => card.style.display !== 'none');
        
        visibleCards.forEach((card, index) => {
            card.classList.add('card-stack-update');
            
            setTimeout(() => {
                if (index === 0) {
                    card.style.transform = 'scale(1) translateY(0px) translateZ(0px)';
                    card.style.zIndex = '5';
                    card.style.opacity = '1';
                } else if (index === 1) {
                    card.style.transform = 'scale(0.96) translateY(8px) translateZ(-20px)';
                    card.style.zIndex = '4';
                    card.style.opacity = '0.9';
                } else if (index === 2) {
                    card.style.transform = 'scale(0.92) translateY(16px) translateZ(-40px)';
                    card.style.zIndex = '3';
                    card.style.opacity = '0.8';
                } else if (index === 3) {
                    card.style.transform = 'scale(0.88) translateY(24px) translateZ(-60px)';
                    card.style.zIndex = '2';
                    card.style.opacity = '0.7';
                }
                
                card.classList.remove('card-stack-update');
            }, 50);
        });
    }
    
    showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `fixed top-24 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-lg text-white font-semibold`;
        
        if (type === 'success') {
            toast.style.background = 'linear-gradient(135deg, #059669, #047857)';
        } else if (type === 'super') {
            toast.style.background = 'linear-gradient(135deg, #2563eb, #1d4ed8)';
        } else {
            toast.style.background = 'linear-gradient(135deg, #dc2626, #b91c1c)';
        }
        
        toast.textContent = message;
        toast.style.animation = 'slideDown 0.3s ease-out';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideUp 0.3s ease-in forwards';
            setTimeout(() => toast.remove(), 300);
        }, 1500);
    }
    
    showNoMoreCards() {
        const cardStack = document.getElementById('cardStack');
        cardStack.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 heartbeat" 
                     style="background: linear-gradient(135deg, #f9a8d4, #ec4899);">
                    <i class="fas fa-heart text-3xl text-white"></i>
                </div>
                <h3 class="text-xl font-bold mb-2 gradient-text">You're all caught up!</h3>
                <p class="text-gray-600 mb-6">Check back later for new profiles</p>
                <button onclick="location.reload()" 
                        class="px-6 py-3 rounded-full text-white font-semibold btn-primary">
                    Reset
                </button>
            </div>
        `;
    }
    
    hapticFeedback(intensity = 'medium') {
        if (navigator.vibrate) {
            const patterns = {
                light: 10,
                medium: 50,
                heavy: [50, 30, 50]
            };
            navigator.vibrate(patterns[intensity]);
        }
    }
}

// Initialize the swipe system when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing Fall In swipe system...');
    if (document.querySelector('.swipe-card')) {
        new RealisticSwipe();
        showToast('Ready to find love! 💕 Swipe away!', 'info', 3000);
    }
});
</script>
{% endblock %}